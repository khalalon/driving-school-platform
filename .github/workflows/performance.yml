name: Performance Tests

on:
  schedule:
    - cron: '0 2 * * *' # Daily at 2 AM
  workflow_dispatch:

jobs:
  load-test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [auth, school, lesson, exam, payment, notification]
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup services
        run: |
          docker-compose up -d postgres redis
          docker-compose up -d ${{ matrix.service }}-service
          sleep 10
      
      - name: Install k6
        run: |
          curl https://github.com/grafana/k6/releases/download/v0.47.0/k6-v0.47.0-linux-amd64.tar.gz -L | tar xvz
          sudo cp k6-v0.47.0-linux-amd64/k6 /usr/bin
      
      - name: Run load test
        run: |
          k6 run --out json=results.json tests/performance/${{ matrix.service }}-load-test.js
        continue-on-error: true
      
      - name: Upload results
        uses: actions/upload-artifact@v3
        with:
          name: ${{ matrix.service }}-performance-results
          path: results.json
